# Supabase Directory

<!-- Parent: ../AGENTS.md -->

## Purpose

This directory contains **PostgreSQL database schema definitions and SQL migrations** for the Bible Soom application. The database is hosted on Supabase and manages all persistent data including Bible verses, user annotations, and authentication.

## Key Files

None at root level. See `migrations/` subdirectory for migration files.

## Subdirectories

### migrations/
Contains chronologically numbered SQL migration files that define and evolve the database schema. Migrations are applied in order and should **never be modified** after being applied to production.

**Active Migration Files:**
- `20260102_new_schema.sql` - Initial schema setup
- `20260103_add_unique_constraints.sql` - Added UNIQUE constraints for user data
- `20260103_fix_user_id_references.sql` - Fixed foreign key references
- `20260116_normalized_schema.sql` - **⭐ PRIMARY MIGRATION** - Normalized schema with tables: `new_books`, `book_names`, `translations`, `new_verses`, `verse_translations`
- `20260116_clean_schema.sql` - Schema cleanup operations
- `20260116_user_data_tables.sql` - User data tables: `users`, `notes`, `highlights`, `bookmarks` with RLS policies

### migrations_backup/
Backup of old/deprecated migrations for historical reference. Not used in production.

### .temp/
Temporary files generated by Supabase CLI. Can be ignored.

## For AI Agents

### CRITICAL: Schema Transition in Progress

**⚠️ The project is currently transitioning from wide table schema to normalized schema.**

**Legacy Schema (Being Phased Out):**
- `books` table - 66 Bible books with Korean-centric names
- `verses` table - Wide table with columns per translation (`korhrv`, `niv`, `kornrsv`)
- New translations require ALTER TABLE to add columns

**Normalized Schema (Current Active Schema):**
- `new_books` - Canonical 66 books (language-agnostic, uses `abbr_eng` for URL routing)
- `book_names` - Multilingual book names (ko, en, zh, ja, etc.)
- `translations` - Translation metadata (korHRV, NIV, zhCUV, etc.)
- `new_verses` - Canonical verse structure (no text, just references)
- `verse_translations` - Actual translated text (junction table: verse_id + translation_id)

**Benefits of Normalized Schema:**
- ✅ Add new translations without schema changes (just INSERT data)
- ✅ Multilingual support built-in (`book_names` table)
- ✅ Clean separation of structure and content
- ✅ Consistent verse references across translations (canonical `verse_id`)

### Row Level Security (RLS)

**ALL user data tables MUST have RLS policies enabled.** This is mandatory for security.

**Standard RLS Pattern:**
```sql
ALTER TABLE <table_name> ENABLE ROW LEVEL SECURITY;

-- Read policy
CREATE POLICY "Users can view their own <resource>"
  ON <table_name>
  FOR SELECT
  USING (auth.uid() = user_id);

-- Insert policy
CREATE POLICY "Users can create their own <resource>"
  ON <table_name>
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Update policy
CREATE POLICY "Users can update their own <resource>"
  ON <table_name>
  FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Delete policy
CREATE POLICY "Users can delete their own <resource>"
  ON <table_name>
  FOR DELETE
  USING (auth.uid() = user_id);
```

**Tables with RLS enabled:**
- `users` - User profiles
- `notes` - Verse notes
- `highlights` - Verse highlights
- `bookmarks` - Saved verses

### Migration Best Practices

**NEVER modify existing migrations after they've been applied.** Instead:

1. **Create a new migration file:**
   ```bash
   # Naming: YYYYMMDD_description.sql
   supabase/migrations/20260117_add_new_feature.sql
   ```

2. **Use transactions:**
   ```sql
   BEGIN;
   -- Your changes here
   COMMIT;
   ```

3. **Add comments:**
   ```sql
   COMMENT ON TABLE <table> IS 'Description';
   COMMENT ON COLUMN <table>.<column> IS 'Description';
   ```

4. **Create indexes for foreign keys and frequently queried columns:**
   ```sql
   CREATE INDEX idx_<table>_<column> ON <table>(<column>);
   ```

5. **Always enable RLS for user data:**
   ```sql
   ALTER TABLE <table> ENABLE ROW LEVEL SECURITY;
   ```

### Common Database Operations

**Adding a New Translation (Normalized Schema):**
```sql
-- Step 1: Add translation metadata
INSERT INTO translations (code, name, language, year, available, display_order)
VALUES ('zhCUV', '和合本', 'zh', 1919, true, 10);

-- Step 2: Import verse data (via import script)
-- scripts/import_normalized_<translation>.py
```

**Adding a New User Data Table:**
```sql
CREATE TABLE <table_name> (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  verse_id BIGINT NOT NULL REFERENCES new_verses(id) ON DELETE CASCADE,
  -- other columns
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, verse_id)  -- One record per user per verse
);

-- Add indexes
CREATE INDEX idx_<table>_user_id ON <table>(user_id);
CREATE INDEX idx_<table>_verse_id ON <table>(verse_id);

-- Enable RLS (see pattern above)
ALTER TABLE <table> ENABLE ROW LEVEL SECURITY;
-- ... create policies ...
```

**Full-Text Search Index:**
```sql
-- For verse_translations table
CREATE INDEX idx_verse_translations_text_gin
  ON verse_translations
  USING gin(to_tsvector('english', text));
```

## Dependencies

- **Supabase PostgreSQL** - Managed PostgreSQL database with built-in auth and RLS
- **Supabase CLI** - For running migrations locally: `supabase db push`
- **RLS Policies** - Row Level Security for user data protection
- **Auth Schema** - Supabase `auth.users` table (referenced by `users.id`)
- **Import Scripts** - Python scripts in `/scripts/` for bulk data import

## Related Files

- `/lib/supabase/server.ts` - Server-side Supabase client (for migrations and API routes)
- `/scripts/import_normalized_*.py` - Import scripts for verse data
- `/CLAUDE.md` - Project architecture documentation (see "Schema Migration Strategy" section)
- `/MIGRATION_GUIDE.md` - Detailed guide for schema transition

## Migration Status Tracker

**Current State:** Normalized schema deployed, legacy schema still present for compatibility.

**Completed:**
- ✅ Normalized schema tables created
- ✅ RLS policies implemented
- ✅ User data tables migrated to normalized schema
- ✅ Import scripts updated

**Pending:**
- ⏳ Full data migration from legacy to normalized tables
- ⏳ API route conversion to use normalized schema
- ⏳ Frontend conversion to dynamic translation loading
- ⏳ Legacy table removal (after full transition)

**Rollback Plan:** Both schemas coexist, allowing safe rollback during transition period.
